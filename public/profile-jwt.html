<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - QuickMart (JWT Enhanced)</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .jwt-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-left: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .security-status {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .token-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #007bff;
        }
        
        .token-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .enhanced-analytics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .analytics-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #4CAF50;
        }
        
        .analytics-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        
        .analytics-label {
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <a href="/" class="logo">QuickMart</a>
            <nav>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="products.html">Products</a></li>
                    <li><a href="cart.html">Cart</a></li>
                    <li><a href="/profile-jwt.html" class="active">Profile</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="profile-container">
        <h1>My Profile <span class="jwt-badge">üîí JWT Secured</span></h1>
        
        <!-- Security Status -->
        <div class="security-status">
            <h3>üõ°Ô∏è Enhanced Security Active</h3>
            <p>Your account is protected with JWT (JSON Web Token) authentication for maximum security.</p>
            <div id="authStatusInfo">Loading authentication status...</div>
        </div>
        
        <!-- Loading State -->
        <div id="loadingState" class="loading-state">
            <p>Loading profile...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-state" style="display:none;">
            <p id="errorMessage">Something went wrong. Please try again.</p>
            <button onclick="window.location.reload()">Retry</button>
        </div>

        <!-- Profile Content -->
        <div id="profileContent" style="display:none;">
            
            <!-- Profile Overview Card -->
            <div class="profile-card">
                <h2>Profile Information</h2>
                <div class="profile-info" id="profileView">
                    <div class="info-row">
                        <label>Name:</label>
                        <span id="displayName">-</span>
                    </div>
                    <div class="info-row">
                        <label>Email:</label>
                        <span id="displayEmail">-</span>
                    </div>
                    <div class="info-row">
                        <label>Bio:</label>
                        <span id="displayBio">No bio provided</span>
                    </div>
                    <div class="info-row">
                        <label>Member Since:</label>
                        <span id="displayMemberSince">-</span>
                    </div>
                    <button id="editProfileBtn" class="edit-btn">Edit Profile</button>
                </div>

                <!-- Edit Form -->
                <form id="profileEditForm" style="display:none;">
                    <div class="form-group">
                        <label for="editName">Name:</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email:</label>
                        <input type="email" id="editEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="editBio">Bio:</label>
                        <textarea id="editBio" rows="3" placeholder="Tell us about yourself..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" id="saveProfileBtn">Save Changes</button>
                        <button type="button" id="cancelEditBtn">Cancel</button>
                    </div>
                </form>
            </div>

            <!-- Enhanced Analytics Card -->
            <div class="profile-card">
                <h2>Enhanced Account Analytics</h2>
                <div class="enhanced-analytics">
                    <div class="analytics-card">
                        <div class="analytics-number" id="daysSinceMember">-</div>
                        <div class="analytics-label">Days as Member</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-number" id="totalOrders">-</div>
                        <div class="analytics-label">Total Orders</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-number" id="totalSpent">-</div>
                        <div class="analytics-label">Total Spent</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-number" id="securityLevel">-</div>
                        <div class="analytics-label">Security Level</div>
                    </div>
                </div>
            </div>

            <!-- JWT Token Management -->
            <div class="profile-card">
                <h2>üîê Token Management</h2>
                <div class="token-info">
                    <p><strong>Authentication Method:</strong> <span id="authMethod">JWT</span></p>
                    <p><strong>Token Status:</strong> <span id="tokenStatus">Valid</span></p>
                    <p><strong>Security Level:</strong> <span id="securityLevelDetail">High</span></p>
                    
                    <div class="token-actions">
                        <button id="refreshTokenBtn" class="btn-secondary">üîÑ Refresh Token</button>
                        <button id="revokeTokenBtn" class="btn-danger">üö´ Revoke All Tokens</button>
                    </div>
                </div>
            </div>

            <!-- Password Change Card -->
            <div class="profile-card">
                <h2>Change Password</h2>
                <form id="passwordChangeForm">
                    <div class="form-group">
                        <label for="currentPassword">Current Password:</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password:</label>
                        <input type="password" id="newPassword" required minlength="6">
                        <div class="password-strength" id="passwordStrength"></div>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password:</label>
                        <input type="password" id="confirmPassword" required>
                        <div class="password-match" id="passwordMatch"></div>
                    </div>
                    <button type="submit" id="changePasswordBtn">Change Password</button>
                </form>
            </div>

            <!-- Actions -->
            <div class="profile-actions">
                <button onclick="window.location.href='/'" class="secondary-btn">Back to Home</button>
                <button id="logoutFromProfile" class="danger-btn">Logout</button>
                <button onclick="window.location.href='/profile.html'" class="secondary-btn">Standard Profile</button>
            </div>
        </div>
    </div>

    <script>
        // JWT Profile Management
        document.addEventListener('DOMContentLoaded', async () => {
            await checkJWTAuthAndLoadProfile();
            setupEventListeners();
        });

        // Check JWT authentication and load profile
        async function checkJWTAuthAndLoadProfile() {
            const token = localStorage.getItem('accessToken');
            
            if (!token) {
                // No token, redirect to login
                window.location.href = '/login-jwt.html';
                return;
            }

            try {
                // Verify token and load profile
                const response = await fetch('/profile/jwt', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        // Token expired or invalid
                        localStorage.removeItem('accessToken');
                        window.location.href = '/login-jwt.html';
                        return;
                    }
                    throw new Error('Failed to load profile');
                }

                const profile = await response.json();
                
                // Update profile display
                document.getElementById('displayName').textContent = profile.name;
                document.getElementById('displayEmail').textContent = profile.email;
                document.getElementById('displayBio').textContent = profile.bio || 'No bio provided';
                document.getElementById('displayMemberSince').textContent = new Date(profile.createdAt).toLocaleDateString();
                
                // Update auth status
                document.getElementById('authStatusInfo').innerHTML = `
                    <strong>Authentication Type:</strong> ${profile.authType || 'JWT'}<br>
                    <strong>Status:</strong> ‚úÖ Active and Secure<br>
                    <strong>Token Valid:</strong> Yes
                `;

                // Load analytics
                await loadJWTAnalytics();
                
                // Show profile content
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('profileContent').style.display = 'block';

            } catch (error) {
                console.error('Error loading profile:', error);
                showError('Failed to load profile. Please try again.');
            }
        }

        // Load enhanced analytics with JWT
        async function loadJWTAnalytics() {
            try {
                const token = localStorage.getItem('accessToken');
                const response = await fetch('/profile/jwt/analytics', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch analytics');
                
                const analytics = await response.json();
                
                document.getElementById('daysSinceMember').textContent = analytics.daysSinceMember || 0;
                document.getElementById('totalOrders').textContent = analytics.totalOrders || 0;
                document.getElementById('totalSpent').textContent = `$${analytics.totalSpent || 0}`;
                document.getElementById('securityLevel').textContent = analytics.sessionInfo?.securityLevel || 'High';

                // Update auth method info
                if (analytics.sessionInfo) {
                    document.getElementById('authMethod').textContent = analytics.sessionInfo.authenticatedVia.toUpperCase();
                    document.getElementById('securityLevelDetail').textContent = analytics.sessionInfo.securityLevel;
                    document.getElementById('tokenStatus').textContent = analytics.sessionInfo.isJWT ? 'Active JWT' : 'Session';
                }

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Edit profile toggle
            document.getElementById('editProfileBtn').addEventListener('click', () => {
                toggleEditMode(true);
            });

            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                toggleEditMode(false);
            });

            // Profile form submission
            document.getElementById('profileEditForm').addEventListener('submit', handleJWTProfileUpdate);

            // Password form submission
            document.getElementById('passwordChangeForm').addEventListener('submit', handleJWTPasswordChange);

            // Token management
            document.getElementById('refreshTokenBtn').addEventListener('click', refreshJWTToken);
            document.getElementById('revokeTokenBtn').addEventListener('click', revokeAllTokens);

            // Password strength checking
            document.getElementById('newPassword').addEventListener('input', checkPasswordStrength);
            document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);

            // Logout
            document.getElementById('logoutFromProfile').addEventListener('click', handleJWTLogout);
        }

        // Handle JWT profile update
        async function handleJWTProfileUpdate(e) {
            e.preventDefault();
            
            const saveBtn = document.getElementById('saveProfileBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const formData = {
                    name: document.getElementById('editName').value,
                    email: document.getElementById('editEmail').value,
                    bio: document.getElementById('editBio').value
                };

                const token = localStorage.getItem('accessToken');
                const response = await fetch('/profile/jwt', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update profile');
                }

                // Refresh profile display
                await checkJWTAuthAndLoadProfile();
                toggleEditMode(false);
                showSuccess('Profile updated successfully with JWT security!');

            } catch (error) {
                console.error('Error updating profile:', error);
                showError(error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        // Handle JWT password change
        async function handleJWTPasswordChange(e) {
            e.preventDefault();
            
            const changeBtn = document.getElementById('changePasswordBtn');
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showError('New passwords do not match');
                return;
            }

            changeBtn.disabled = true;
            changeBtn.textContent = 'Changing...';

            try {
                const token = localStorage.getItem('accessToken');
                const response = await fetch('/profile/jwt/password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to change password');
                }

                document.getElementById('passwordChangeForm').reset();
                document.getElementById('passwordStrength').textContent = '';
                document.getElementById('passwordMatch').textContent = '';
                showSuccess('Password changed successfully with JWT authentication!');

            } catch (error) {
                console.error('Error changing password:', error);
                showError(error.message);
            } finally {
                changeBtn.disabled = false;
                changeBtn.textContent = 'Change Password';
            }
        }

        // Refresh JWT Token
        async function refreshJWTToken() {
            try {
                const response = await fetch('/auth/jwt-refresh', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Failed to refresh token');
                }

                const data = await response.json();
                localStorage.setItem('accessToken', data.accessToken);
                
                showSuccess('Token refreshed successfully!');
                setTimeout(() => window.location.reload(), 1000);

            } catch (error) {
                console.error('Error refreshing token:', error);
                showError('Failed to refresh token. Please login again.');
                setTimeout(() => window.location.href = '/login-jwt.html', 2000);
            }
        }

        // Revoke all tokens (logout)
        async function revokeAllTokens() {
            if (!confirm('This will log you out from all devices. Continue?')) {
                return;
            }

            try {
                await fetch('/auth/jwt-logout', { method: 'POST' });
                localStorage.removeItem('accessToken');
                showSuccess('All tokens revoked successfully!');
                setTimeout(() => window.location.href = '/login-jwt.html', 1000);
            } catch (error) {
                console.error('Error revoking tokens:', error);
                // Still redirect even if there's an error
                localStorage.removeItem('accessToken');
                window.location.href = '/login-jwt.html';
            }
        }

        // Handle JWT logout
        async function handleJWTLogout() {
            try {
                await fetch('/auth/jwt-logout', { method: 'POST' });
                localStorage.removeItem('accessToken');
                window.location.href = '/';
            } catch (error) {
                console.error('Error logging out:', error);
                // Still redirect even if there's an error
                localStorage.removeItem('accessToken');
                window.location.href = '/';
            }
        }

        // Utility functions (reuse from profile.js)
        function toggleEditMode(editMode) {
            const profileView = document.getElementById('profileView');
            const editForm = document.getElementById('profileEditForm');

            if (editMode) {
                document.getElementById('editName').value = document.getElementById('displayName').textContent;
                document.getElementById('editEmail').value = document.getElementById('displayEmail').textContent;
                document.getElementById('editBio').value = document.getElementById('displayBio').textContent === 'No bio provided' ? '' : document.getElementById('displayBio').textContent;

                profileView.style.display = 'none';
                editForm.style.display = 'block';
            } else {
                profileView.style.display = 'block';
                editForm.style.display = 'none';
                editForm.reset();
            }
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthEl = document.getElementById('passwordStrength');
            
            if (password.length === 0) {
                strengthEl.textContent = '';
                return;
            }

            let strength = 0;
            let feedback = [];

            if (password.length >= 8) strength++;
            else feedback.push('at least 8 characters');

            if (/[A-Z]/.test(password)) strength++;
            else feedback.push('uppercase letter');

            if (/[0-9]/.test(password)) strength++;
            else feedback.push('number');

            if (/[^A-Za-z0-9]/.test(password)) strength++;
            else feedback.push('special character');

            const levels = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
            const level = levels[strength];
            
            strengthEl.textContent = `Strength: ${level}`;
            strengthEl.className = `password-strength strength-${strength}`;
            
            if (feedback.length > 0 && strength < 3) {
                strengthEl.textContent += ` (add ${feedback.join(', ')})`;
            }
        }

        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchEl = document.getElementById('passwordMatch');
            
            if (confirmPassword.length === 0) {
                matchEl.textContent = '';
                return;
            }

            if (newPassword === confirmPassword) {
                matchEl.textContent = '‚úì Passwords match';
                matchEl.className = 'password-match match-good';
            } else {
                matchEl.textContent = '‚úó Passwords do not match';
                matchEl.className = 'password-match match-bad';
            }
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('profileContent').style.display = 'none';
            
            setTimeout(() => {
                document.getElementById('errorState').style.display = 'none';
                document.getElementById('profileContent').style.display = 'block';
            }, 5000);
        }

        function showSuccess(message) {
            const successEl = document.createElement('div');
            successEl.className = 'success-message';
            successEl.textContent = message;
            successEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 12px 24px;
                border-radius: 4px;
                z-index: 1000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            `;
            
            document.body.appendChild(successEl);
            
            setTimeout(() => {
                successEl.remove();
            }, 3000);
        }
    </script>
</body>
</html>